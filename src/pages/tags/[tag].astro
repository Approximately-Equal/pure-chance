---
import BaseLayout from "../../layouts/base.astro";
import { getCollection, render } from "astro:content";

export async function getStaticPaths() {
    const allArticles: any[] = await getCollection("articles", ({ data }) => {
        return import.meta.env.PROD ? data.draft !== true : true;
    });

    const tags = [
        ...new Set(allArticles.flatMap((article) => article.data.tags ?? [])),
    ];

    return tags.map((tag) => ({
        params: { tag },
        props: {
            articles: allArticles
                .filter((article) => article.data.tags?.includes(tag))
                .sort(
                    (a, b) =>
                        b.data.dates.published.getTime() -
                        a.data.dates.published.getTime(),
                ),
            tag,
        },
    }));
}

const { tag } = Astro.params;
const { articles } = Astro.props;
---

<BaseLayout>
    <ul class={`${tag} archive`}>
        {
            articles.map((article: any) => (
                <li>
                    <a href={`/articles/${article.id}`}>{article.data.title}</a>
                    <time
                        datetime={article.data.dates.published
                            .toISOString()
                            .split("T")[0]
                            .trim()}
                    >
                        {article.data.dates.published
                            .toISOString()
                            .split("T")[0]
                            .trim()}
                    </time>
                </li>
            ))
        }
    </ul>
</BaseLayout>
